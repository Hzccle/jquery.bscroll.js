/* Copyright (c) 2014 Sigura Brice
 * Licensed under the Creative Commons License
 */
(function(e){"use strict";window.bScrolls=[];e.fn.bScroll=function(t){function n(t,n){this.$target=t;this.dimensions=null;this.options=e.extend(true,{speed:20,propagate:false,events:{arrows:true,mousewheel:true,touchscreen:true,resize:true,lifts:true},autoupdate:50},n);this.needs={x:false,y:false};this.scrolls={x:null,y:null};this.init=function(){this.initTarget();this.dimensions=this.calculateDimensions();this.needs=this.checkNeeds();this.createScrolls();this.placeScrolls();this.initEvents()};this.onResize=function(e){e.data.t.removeScrolls();e.data.t.dimensions=e.data.t.calculateDimensions();e.data.t.needs=e.data.t.checkNeeds();e.data.t.createScrolls();e.data.t.placeScrolls();e.data.t.initEvents()};this.initEvents=function(){this.resetEvents();this.$target.on("mouseenter",{t:this},this.onMouseEnter);this.$target.on("mouseleave",{t:this},this.onMouseLeave);if(this.options.events.mousewheel){this.$target.on("mousewheel",{t:this},this.onMouseWheel)}if(this.options.events.arrows){this.$target.on("keydown",{t:this},this.onKeyDown)}var t=this,n="ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,r={x:0,y:0};if(this.options.events.arrows){if(n){this.$target.on("touchstart",{start:r,t:this},this.onTouchStart);this.$target.on("touchmove",{start:r,t:this},this.onTouchMove);this.$target.on("touchend",{start:r,t:this},this.onTouchEnd)}}if(this.options.events.lifts){this.$target.children(".bs-scroll-x, .bs-scroll-y").on("mousedown",{start:r,t:this},this.onMouseDownLift)}if(this.options.events.resize){e(window).on("resize",{t:this},this.onResize);this.$target.on("resize",{t:this},this.onResize)}if(this.options.autoupdate){this.intervalChecker=setInterval(function(){var e=t.calculateDimensions(),n=t.scrolls.x,r=t.scrolls.y;if(t.dimensions.scrollWidth!==e.scrollWidth||t.dimensions.scrollHeight!==e.scrollHeight){if(e.scrollHeight!==t.dimensions.scrollHeight+(n?n.$scroll.height():0)+(r?r.$scroll.height():0)||e.width!==t.dimensions.width){t.$target.resize()}}},this.options.autoupdate)}};this.onMouseEnter=function(e){if(e.data.t.options.events.arrows){e.data.t.$target.attr("tabindex",0);e.data.t.$target.focus()}e.data.t.$target.children(".bs-scroll-x, .bs-scroll-y").show();e.preventDefault();e.stopPropagation()};this.onMouseLeave=function(e){if(!e.data.t.$target.hasClass("bs-lift-moving")){if(e.data.t.options.events.arrows){e.data.t.$target.blur();e.data.t.$target.removeAttr("tabindex")}e.data.t.$target.children(".bs-scroll-x, .bs-scroll-y").hide()}e.preventDefault();e.stopPropagation()};this.onMouseWheel=function(e){var t={x:e.deltaX!==0?e.deltaX*e.data.t.options.speed:0,y:e.deltaY!==0?-e.deltaY*e.data.t.options.speed:0};e.data.t.scrollTarget(t,e)};this.onKeyDown=function(e){var t={x:0,y:0};if(e.which===37&&e.data.t.needs.x){t.x=-e.data.t.options.speed}if(e.which===39&&e.data.t.needs.x){t.x=e.data.t.options.speed}if(e.which===38&&e.data.t.needs.y){t.y=-e.data.t.options.speed}if(e.which===40&&e.data.t.needs.y){t.y=e.data.t.options.speed}e.data.t.scrollTarget(t,e)};this.onMouseDownLift=function(t){t.data.t.$target.addClass("bs-lift-moving");t.data.start.x=t.pageX;t.data.start.y=t.pageY;var n={start:t.data.start,t:t.data.t,lift:this.className.slice(-1)};e(window).on("mousemove",n,t.data.t.onMouseMoveLift);e(window).on("mouseup",n,t.data.t.onMouseUpLift);t.preventDefault();t.stopPropagation()};this.onMouseUpLift=function(t){e(window).unbind("mousemove",t.data.t.onMouseMoveLift);e(window).unbind("mouseup",t.data.t.onMouseUpLift);t.data.start.x=0;t.data.start.y=0;t.data.t.$target.removeClass("bs-lift-moving")};this.onMouseMoveLift=function(e){var t={x:e.data.lift==="x"?(e.pageX-e.data.start.x)*e.data.t.dimensions.scrollWidth/e.data.t.dimensions.outerWidth:0,y:e.data.lift==="y"?(e.pageY-e.data.start.y)*e.data.t.dimensions.scrollHeight/e.data.t.dimensions.outerHeight:0};e.data.start.x=e.pageX;e.data.start.y=e.pageY;e.data.t.scrollTarget(t,e)};this.onTouchStart=function(e){e.data.t.scrolls.x.$scroll.show();e.data.t.scrolls.y.$scroll.show();var t=e.originalEvent.targetTouches[0];e.data.start.x=t.pageX;e.data.start.y=t.pageY};this.onTouchMove=function(e){var t=e.originalEvent.targetTouches[0],n={x:e.data.t.options.speed*(e.data.start.x-t.pageX)/10,y:e.data.t.options.speed*(e.data.start.y-t.pageY)/10};e.data.t.scrollTarget(n,e);e.data.start.x=t.pageX;e.data.start.y=t.pageY};this.onTouchEnd=function(e){e.data.t.scrolls.x.$scroll.hide();e.data.t.scrolls.y.$scroll.hide();e.data.start.x=0;e.data.start.y=0};this.scrollTarget=function(e,t){e=this.normalizeDeltas(e);var n=navigator.userAgent.match(/OPR\//)?1:0;this.$target.scrollLeft(e.x+t.data.t.$target.scrollLeft()+n);this.$target.scrollTop(e.y+t.data.t.$target.scrollTop()+n);this.beforePlaceScrolls(e,t);this.placeScrolls()};this.beforePlaceScrolls=function(e,t){if(e.x!==0||e.y!==0){if(this.options.propagate!=="always"){t.preventDefault();t.stopPropagation()}t.data.t.placeScrolls()}else{if(!this.options.propagate){t.preventDefault();t.stopPropagation()}}};this.normalizeDeltas=function(e){if(e.x+this.$target.scrollLeft()>this.dimensions.scrollWidth-this.dimensions.outerWidth){e.x=this.dimensions.scrollWidth-this.dimensions.outerWidth-this.$target.scrollLeft()}if(e.x+this.$target.scrollLeft()<0){e.x=-this.$target.scrollLeft()}if(e.y+this.$target.scrollTop()>this.dimensions.scrollHeight-this.dimensions.outerHeight){e.y=this.dimensions.scrollHeight-this.dimensions.outerHeight-this.$target.scrollTop()}if(e.y+this.$target.scrollTop()<0){e.y=-this.$target.scrollTop()}return e};this.resetEvents=function(){this.$target.unbind("mousewheel",this.onMouseWheel);this.$target.unbind("mouseenter",this.onMouseEnter);this.$target.unbind("mousemove",this.onMouseMove);this.$target.unbind("mouseleave",this.onMouseLeave);this.$target.unbind("keydown",this.onKeyDown);this.$target.unbind("touchstart",this.onTouchStart);this.$target.unbind("touchmove",this.onTouchMove);this.$target.unbind("touchend",this.onTouchEnd);this.$target.unbind("resize",this.onResize);this.$target.unbind("scroll",this.placeScrolls);this.$target.children(".bs-scroll-x, .bs-scroll-y").unbind("mousedown");e(window).unbind("mousemove",this.onMouseMoveLift);e(window).unbind("mouseup",this.onMouseUpLift);e(window).unbind("resize",this.onResize);clearInterval(this.intervalChecker)};this.createScrolls=function(){if(this.needs.x){this.scrolls.x=this.createScroll("x")}if(this.needs.y){this.scrolls.y=this.createScroll("y")}};this.createScroll=function(t){var n=e("<div>"),r=e("<div>");n.addClass("bs-lift-"+t).css({position:"relative"});r.addClass("bs-scroll-"+t).css({position:"relative"}).append(n).appendTo(this.$target);this.dimensions.scrolls[t].offsetTop=r[0].offsetTop;return{$scroll:r,$lift:n}};this.placeScrolls=function(){if(this.needs.x){this.placeScrollX()}if(this.needs.y){this.placeScrollY()}};this.placeScrollX=function(){this.scrolls.x.$scroll.css({width:this.dimensions.outerWidth,left:this.$target.scrollLeft()-this.dimensions.padding.left,top:this.$target.scrollTop()-this.dimensions.scrolls.x.offsetTop+this.dimensions.outerHeight-this.scrolls.x.$scroll.height()});this.placeLiftX()};this.placeLiftX=function(){this.scrolls.x.$lift.css({left:this.$target.scrollLeft()*this.dimensions.outerWidth/this.dimensions.scrollWidth,width:this.scrolls.x.$scroll.width()*this.dimensions.outerWidth/this.dimensions.scrollWidth})};this.placeScrollY=function(){this.scrolls.y.$scroll.css({height:this.dimensions.outerHeight,left:this.$target.scrollLeft()-this.dimensions.padding.left+this.dimensions.outerWidth-this.scrolls.y.$scroll.width(),top:this.$target.scrollTop()-this.dimensions.scrolls.y.offsetTop});this.placeLiftY()};this.placeLiftY=function(){this.scrolls.y.$lift.css({top:this.$target.scrollTop()*this.dimensions.outerHeight/this.dimensions.scrollHeight,height:this.scrolls.y.$scroll.height()*this.dimensions.outerHeight/this.dimensions.scrollHeight})};this.removeScrolls=function(){this.scrolls.x=null;this.scrolls.y=null;this.$target.children(".bs-scroll-x, .bs-scroll-y").remove()};this.checkNeeds=function(){return{x:this.dimensions.scrollWidth>this.dimensions.outerWidth,y:this.dimensions.scrollHeight>this.dimensions.outerHeight}};this.initTarget=function(){this.$target.addClass("bs-container").css({overflow:"hidden",outline:"none"})};this.calculateDimensions=function(){return{innerWidth:Math.round(this.$target.width()),innerHeight:Math.round(this.$target.height()),outerWidth:Math.round(this.$target.width()+parseInt(this.$target.css("padding-left"))+parseInt(this.$target.css("padding-right"))),outerHeight:Math.round(this.$target.height()+parseInt(this.$target.css("padding-top"))+parseInt(this.$target.css("padding-bottom"))),scrollWidth:this.$target[0].scrollWidth,scrollHeight:this.$target[0].scrollHeight,padding:{top:Math.round(parseInt(this.$target.css("padding-top"))),left:Math.round(parseInt(this.$target.css("padding-left"))),right:Math.round(parseInt(this.$target.css("padding-right"))),bottom:Math.round(parseInt(this.$target.css("padding-bottom")))},scrolls:{x:{offsetTop:0},y:{offsetTop:0}}}}}if(t===undefined){t={}}if(this.selector===""&&t==="resize"){e.each(window.bScrolls,function(e,t){t.resize()})}this.each(function(){var r=e(this),i=null;if(typeof t==="string"){e.each(window.bScrolls,function(e,n){if(n.$target.context===r.context){switch(t){case"resize":n.$target.resize();break;case"destroy":n.destroy();delete window.bScrolls[e];break}}})}else{i=new n(e(this),t);window.bScrolls.push(i);i.init();return i}});return this}})(jQuery)
